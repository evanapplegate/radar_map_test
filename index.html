<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vectorized Radar - d3-contour</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div style="position: absolute; top: 10px; left: 10px; z-index: 100; background: white; padding: 10px;">
        <label>
            <input type="checkbox" id="radarToggle" checked> Radar
        </label>
    </div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZXZhbmRhcHBsZWdhdGUiLCJhIjoiY2tmbzA1cWM1MWozeTM4cXV4eHUwMzFhdiJ9.Z5f9p8jJD_N1MQwycF2NEw';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/evandapplegate/clxz2cnql006d01qj7ipr447c',
            projection: 'globe',
            center: [-98, 39],
            zoom: 4,
            pitch: 60
        });

        map.on('load', () => {
            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.terrain-rgb',
                'tileSize': 512,
                'maxzoom': 14
            });
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });

            // Function to fetch image, trace contours, and add polygon layer
            async function vectorizeRadar(z, x, y) {
                const url = `https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/${z}/${x}/${y}.png`;
                
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = url;
                
                await new Promise(r => img.onload = r);
                
                // Draw to canvas to read pixels
                const w = img.width;
                const h = img.height;
                const canvas = document.createElement('canvas');
                canvas.width = w;
                canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                const imgData = ctx.getImageData(0, 0, w, h);
                const values = new Float64Array(w * h);
                
                // Extract "rain intensity" from pixel data
                // Radar tiles are usually colored. We can use Alpha or Luminance.
                // Let's use Alpha first to detect "is there stuff here"
                for (let i = 0; i < values.length; i++) {
                    // Alpha is at i*4 + 3
                    // If alpha > 0, check intensity.
                    // Mesonet tiles: Index 0-255 usually.
                    // Simple approach: Use Alpha channel normalized 0-1
                    values[i] = imgData.data[i * 4 + 3] / 255.0;
                }

                // Generate Contours (Marching Squares)
                // Thresholds: 0.1 (light rain), 0.5 (heavy)
                const thresholds = [0.1, 0.4, 0.7];
                const contours = d3.contours()
                    .size([w, h])
                    .thresholds(thresholds)
                    (values);
                
                // Convert pixel coordinates to Lat/Lon GeoJSON
                // Tile to Lat/Lon transform
                const n = Math.pow(2, z);
                const lon1 = x / n * 360 - 180;
                const lon2 = (x + 1) / n * 360 - 180;
                const latRad1 = Math.atan(Math.sinh(Math.PI * (1 - 2 * y / n)));
                const latRad2 = Math.atan(Math.sinh(Math.PI * (1 - 2 * (y + 1) / n)));
                const lat1 = latRad1 * 180 / Math.PI;
                const lat2 = latRad2 * 180 / Math.PI;
                
                const latDiff = lat2 - lat1;
                const lonDiff = lon2 - lon1;

                const features = [];

                contours.forEach(contour => {
                    if (!contour.coordinates.length) return;
                    
                    // contour.value is the threshold value
                    // We can map this to a "height" or "color"
                    
                    const geometry = {
                        type: "MultiPolygon",
                        coordinates: contour.coordinates.map(rings => {
                            return rings.map(ring => {
                                return ring.map(([px, py]) => {
                                    // Map pixel (0..256) to Lat/Lon bounds
                                    // px is 0..w
                                    const lon = lon1 + (px / w) * lonDiff;
                                    // py is 0..h
                                    const lat = lat1 + (py / h) * latDiff;
                                    return [lon, lat];
                                });
                            });
                        })
                    };
                    
                    features.push({
                        type: "Feature",
                        properties: {
                            level: contour.value // 0.1, 0.4, 0.7
                        },
                        geometry: geometry
                    });
                });

                if (features.length === 0) return;

                const sourceId = `radar-vec-${z}-${x}-${y}`;
                
                if (!map.getSource(sourceId)) {
                    map.addSource(sourceId, {
                        type: 'geojson',
                        data: {
                            type: "FeatureCollection",
                            features: features
                        }
                    });

                    // Shadow Layer (Ground)
                    map.addLayer({
                        id: `${sourceId}-shadow`,
                        type: 'fill',
                        source: sourceId,
                        paint: {
                            'fill-color': '#000000',
                            'fill-opacity': 0.4,
                            'fill-antialias': false
                        }
                    }); // Add shadow first so it's below

                    // Floating Vector Layer
                    map.addLayer({
                        id: `${sourceId}-fill`,
                        type: 'fill-extrusion',
                        source: sourceId,
                        paint: {
                            'fill-extrusion-color': [
                                'interpolate',
                                ['linear'],
                                ['get', 'level'],
                                0.1, '#00ff00', // Green
                                0.4, '#ffff00', // Yellow
                                0.7, '#ff0000'  // Red
                            ],
                            'fill-extrusion-height': [
                                'interpolate',
                                ['linear'],
                                ['get', 'level'],
                                0.1, 18050, // Green: Low
                                0.4, 18100, // Yellow: Medium
                                0.7, 18150  // Red: High
                            ],
                            'fill-extrusion-base': [
                                'interpolate',
                                ['linear'],
                                ['get', 'level'],
                                0.1, 18000, // Green sits on bottom
                                0.4, 18050, // Yellow sits on Green
                                0.7, 18100  // Red sits on Yellow
                            ],
                            'fill-extrusion-opacity': 0.9
                        }
                    });
                }
            }

            // Load a few tiles for demo (US Central)
            // Z:4 X:3 Y:6
            const tilesToLoad = [
                {z:4, x:3, y:6},
                {z:4, x:4, y:6},
                {z:4, x:3, y:5},
                {z:4, x:4, y:5}
            ];
            
            tilesToLoad.forEach(t => vectorizeRadar(t.z, t.x, t.y));

            // Toggle Logic
            document.getElementById('radarToggle').addEventListener('change', (e) => {
                const visibility = e.target.checked ? 'visible' : 'none';
                
                // Toggle all radar layers
                const style = map.getStyle();
                if (style && style.layers) {
                    style.layers.forEach(layer => {
                        if (layer.id.includes('radar-vec-')) {
                            map.setLayoutProperty(layer.id, 'visibility', visibility);
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>
